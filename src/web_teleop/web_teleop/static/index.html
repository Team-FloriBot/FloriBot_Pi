<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>FloriBot Web Teleop</title>

  <style>
    /* Kein Scrollen, keine Textmarkierung, kein iOS Callout */
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      overscroll-behavior: none;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: none;
      background: #fff;
      font-family: sans-serif;
    }

    .page {
      height: 100%;
      width: 100%;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 10px;
      padding: 14px;
      box-sizing: border-box;
    }

    .top {
      display: grid;
      gap: 6px;
    }

    .title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }

    .status {
      margin: 0;
      font-size: 14px;
    }

    .out code {
      background: #f6f6f6;
      padding: 2px 6px;
      border-radius: 6px;
    }

    .controls {
      display: grid;
      gap: 12px;
      align-items: center;
      justify-items: center;
    }

    .slider {
      width: min(520px, 100%);
      display: grid;
      grid-template-columns: 140px 1fr 60px;
      gap: 10px;
      align-items: center;
      font-size: 14px;
    }

    input[type="range"] { width: 100%; }

    /* Joystick */
    .joystick {
      width: min(78vw, 380px);
      max-width: 380px;
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      border: 2px solid #bbb;
      background: radial-gradient(circle at 30% 30%, #fafafa, #eaeaea);
      position: relative;
      touch-action: none;
    }

    .stick {
      width: 34%;
      height: 34%;
      border-radius: 999px;
      border: 2px solid #888;
      background: radial-gradient(circle at 30% 30%, #ffffff, #dcdcdc);
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    .center-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #888;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      opacity: 0.7;
      pointer-events: none;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="top">
      <p class="title">Web Teleop</p>
      <p class="status" id="wsStatus">WebSocket: nicht verbunden</p>
      <p class="status out">Sende: <code id="out">v=0.00 m/s, w=0.00 rad/s</code></p>
    </div>

    <div class="controls">
      <div class="slider">
        <label for="vmax">Max v (m/s)</label>
        <input id="vmax" type="range" min="0.05" max="1.00" step="0.05" value="0.25" />
        <span id="vmaxVal">0.25</span>
      </div>

      <div class="slider">
        <label for="wmax">Max w (rad/s)</label>
        <input id="wmax" type="range" min="0.10" max="3.00" step="0.10" value="0.90" />
        <span id="wmaxVal">0.90</span>
      </div>

      <div class="joystick" id="joystick" aria-label="Touch Joystick">
        <div class="center-dot"></div>
        <div class="stick" id="stick"></div>
      </div>
    </div>
  </div>

<script>
  // Zusätzlich Standard-Gesten verhindern (iOS/Safari)
  document.addEventListener("gesturestart", (e) => e.preventDefault(), { passive: false });
  document.addEventListener("gesturechange", (e) => e.preventDefault(), { passive: false });
  document.addEventListener("gestureend", (e) => e.preventDefault(), { passive: false });

  // ---------- WebSocket ----------
  const wsStatus = document.getElementById("wsStatus");
  const outEl = document.getElementById("out");

  const ws = new WebSocket(`ws://${location.host}/ws`);
  ws.onopen = () => wsStatus.textContent = "WebSocket: verbunden";
  ws.onclose = () => wsStatus.textContent = "WebSocket: getrennt";

  function send(v, w) {
    if (ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ v: v, w: w }));
    }
  }

  // ---------- UI ----------
  const vmax = document.getElementById("vmax");
  const wmax = document.getElementById("wmax");
  const vmaxVal = document.getElementById("vmaxVal");
  const wmaxVal = document.getElementById("wmaxVal");

  function updateLabels() {
    vmaxVal.textContent = Number(vmax.value).toFixed(2);
    wmaxVal.textContent = Number(wmax.value).toFixed(2);
  }
  vmax.oninput = wmax.oninput = updateLabels;
  updateLabels();

  // ---------- Helpers ----------
  function clamp(x, lo, hi) { return Math.max(lo, Math.min(hi, x)); }

  // ---------- Joystick state (normalized) ----------
  const joy = document.getElementById("joystick");
  const stick = document.getElementById("stick");

  let active = false;
  let pointerId = null;

  let jx = 0.0; // [-1..1], rechts positiv
  let jy = 0.0; // [-1..1], hoch positiv

  function setStickVisual(nx, ny) {
    const rect = joy.getBoundingClientRect();
    const radius = rect.width * 0.5;
    const maxTravel = radius * 0.55;

    const px = nx * maxTravel;
    const py = -ny * maxTravel;

    stick.style.transform = `translate(${px}px, ${py}px) translate(-50%, -50%)`;
  }

  function resetJoystick() {
    jx = 0.0;
    jy = 0.0;
    setStickVisual(0.0, 0.0);
  }

  function updateFromPointer(clientX, clientY) {
    const rect = joy.getBoundingClientRect();
    const cx = rect.left + rect.width * 0.5;
    const cy = rect.top + rect.height * 0.5;

    let dx = clientX - cx;
    let dy = clientY - cy;

    const radius = rect.width * 0.5;
    const maxTravel = radius * 0.55;

    const dist = Math.hypot(dx, dy);
    if (dist > maxTravel && dist > 0) {
      dx = dx * (maxTravel / dist);
      dy = dy * (maxTravel / dist);
    }

    jx = clamp(dx / maxTravel, -1.0, 1.0);
    jy = clamp(-dy / maxTravel, -1.0, 1.0);

    setStickVisual(jx, jy);
  }

  joy.addEventListener("pointerdown", (e) => {
    active = true;
    pointerId = e.pointerId;
    joy.setPointerCapture(pointerId);
    updateFromPointer(e.clientX, e.clientY);
    e.preventDefault();
  }, { passive: false });

  joy.addEventListener("pointermove", (e) => {
    if (!active || e.pointerId !== pointerId) return;
    updateFromPointer(e.clientX, e.clientY);
    e.preventDefault();
  }, { passive: false });

  function endPointer(e) {
    if (e.pointerId !== pointerId) return;
    active = false;
    pointerId = null;
    resetJoystick();
    send(0.0, 0.0);
    outEl.textContent = `v=0.00 m/s, w=0.00 rad/s`;
    e.preventDefault();
  }

  joy.addEventListener("pointerup", endPointer, { passive: false });
  joy.addEventListener("pointercancel", endPointer, { passive: false });
  joy.addEventListener("lostpointercapture", () => {
    if (!active) return;
    active = false;
    pointerId = null;
    resetJoystick();
    send(0.0, 0.0);
    outEl.textContent = `v=0.00 m/s, w=0.00 rad/s`;
  });

  // ---------- Control loop (20 Hz) ----------
  const PERIOD_MS = 50;

  setInterval(() => {
    const vMax = Number(vmax.value);
    const wMax = Number(wmax.value);

    // v: hoch = vorwärts, runter = rückwärts
    const v = clamp(jy * vMax, -vMax, vMax);

    // w: rechts am Stick -> rechts drehen (Basisvorzeichen -jx)
    // Beim Rückwärtsfahren soll links/rechts nicht "gefühlt" invertieren:
    // => invertiere w, wenn jy < 0 (rückwärts)
    const steerSign = (jy >= 0.0) ? 1.0 : -1.0;
    const w = clamp(((-jx) * wMax) * steerSign, -wMax, wMax);

    if (!active) {
      send(0.0, 0.0);
      outEl.textContent = `v=0.00 m/s, w=0.00 rad/s`;
      return;
    }

    send(v, w);
    outEl.textContent = `v=${v.toFixed(2)} m/s, w=${w.toFixed(2)} rad/s`;
  }, PERIOD_MS);

  resetJoystick();
</script>
</body>
</html>
