<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>FloriBot Web Teleop (Touch Joystick)</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .wrap { max-width: 720px; }
    .card {
      padding: 14px; border: 1px solid #ddd; border-radius: 12px;
      display: grid; gap: 10px;
    }
    .status { margin: 0; }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
    .row { display: grid; grid-template-columns: 200px 1fr 70px; gap: 10px; align-items: center; }
    input[type="range"] { width: 100%; }

    /* Joystick */
    .joy-area {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-items: center;
      justify-items: center;
    }
    .joystick {
      width: min(70vw, 320px);
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      border: 2px solid #bbb;
      background: radial-gradient(circle at 30% 30%, #fafafa, #eaeaea);
      position: relative;
      touch-action: none; /* wichtig für Pointer Events + kein Scroll */
      user-select: none;
    }
    .stick {
      width: 34%;
      height: 34%;
      border-radius: 999px;
      border: 2px solid #888;
      background: radial-gradient(circle at 30% 30%, #ffffff, #dcdcdc);
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .center-dot {
      width: 8px; height: 8px; border-radius: 999px;
      background: #888;
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      opacity: 0.7;
      pointer-events: none;
    }
    .hint { color: #444; line-height: 1.45; margin: 0; }
    .btnrow { display:flex; gap:10px; flex-wrap: wrap; }
    button {
      padding: 10px 14px; border-radius: 10px; border: 1px solid #bbb;
      background: #f7f7f7; font-size: 16px;
    }
    button:active { background: #eaeaea; }
  </style>
</head>
<body>
<div class="wrap">
  <h2>Web Teleop (Touch-Joystick → /cmd_vel)</h2>

  <div class="card">
    <p class="status" id="wsStatus">WebSocket: nicht verbunden</p>
    <p class="status">Sende: <code id="out">v=0.00 m/s, w=0.00 rad/s</code></p>

    <div class="row">
      <label for="vmax">Max vor/zurück (m/s)</label>
      <input id="vmax" type="range" min="0.05" max="1.00" step="0.05" value="0.25" />
      <span id="vmaxVal">0.25</span>
    </div>

    <div class="row">
      <label for="wmax">Max links/rechts (rad/s)</label>
      <input id="wmax" type="range" min="0.10" max="3.00" step="0.10" value="0.90" />
      <span id="wmaxVal">0.90</span>
    </div>

    <div class="row">
      <label for="deadzone">Deadzone</label>
      <input id="deadzone" type="range" min="0.00" max="0.30" step="0.01" value="0.06" />
      <span id="deadzoneVal">0.06</span>
    </div>

    <div class="row">
      <label for="expo">Expo (Feingefühl)</label>
      <input id="expo" type="range" min="1.0" max="3.0" step="0.1" value="1.6" />
      <span id="expoVal">1.6</span>
    </div>

    <div class="btnrow">
      <button id="stopBtn">Stop</button>
      <button id="recenterBtn">Stick zentrieren</button>
    </div>

    <p class="hint">
      Bedienung: Ziehen im Kreis = fahren.<br>
      Hoch = vorwärts, runter = rückwärts, links/rechts = drehen.<br>
      Beim Loslassen stoppt der Roboter (zusätzlich Deadman im Server).
    </p>

    <div class="joy-area">
      <div class="joystick" id="joystick">
        <div class="center-dot"></div>
        <div class="stick" id="stick"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // ---------- WebSocket ----------
  const wsStatus = document.getElementById("wsStatus");
  const outEl = document.getElementById("out");
  const ws = new WebSocket(`ws://${location.host}/ws`);

  ws.onopen = () => wsStatus.textContent = "WebSocket: verbunden";
  ws.onclose = () => wsStatus.textContent = "WebSocket: getrennt";

  function send(v, w) {
    if (ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ v: v, w: w }));
    }
  }

  // ---------- UI ----------
  const vmax = document.getElementById("vmax");
  const wmax = document.getElementById("wmax");
  const deadzone = document.getElementById("deadzone");
  const expo = document.getElementById("expo");

  const vmaxVal = document.getElementById("vmaxVal");
  const wmaxVal = document.getElementById("wmaxVal");
  const deadzoneVal = document.getElementById("deadzoneVal");
  const expoVal = document.getElementById("expoVal");

  function updateLabels() {
    vmaxVal.textContent = Number(vmax.value).toFixed(2);
    wmaxVal.textContent = Number(wmax.value).toFixed(2);
    deadzoneVal.textContent = Number(deadzone.value).toFixed(2);
    expoVal.textContent = Number(expo.value).toFixed(1);
  }
  vmax.oninput = wmax.oninput = deadzone.oninput = expo.oninput = updateLabels;
  updateLabels();

  // ---------- Math helpers ----------
  function clamp(x, lo, hi) { return Math.max(lo, Math.min(hi, x)); }

  function applyDeadzone01(x, dz) {
    const ax = Math.abs(x);
    if (ax < dz) return 0.0;
    const sign = Math.sign(x);
    const scaled = (ax - dz) / (1.0 - dz);
    return sign * scaled;
  }

  function applyExpo(x, e) {
    const sign = Math.sign(x);
    return sign * Math.pow(Math.abs(x), e);
  }

  // ---------- Joystick state (normalized: x,y in [-1..1]) ----------
  const joy = document.getElementById("joystick");
  const stick = document.getElementById("stick");

  let active = false;
  let pointerId = null;

  // normalized command from joystick
  let jx = 0.0; // left/right
  let jy = 0.0; // up/down (positive up in our convention)

  function setStickVisual(nx, ny) {
    // nx, ny in [-1..1]
    const rect = joy.getBoundingClientRect();
    const radius = rect.width * 0.5;
    const maxTravel = radius * 0.55; // knob travel limit

    const px = nx * maxTravel;
    const py = -ny * maxTravel; // screen y downwards

    stick.style.transform = `translate(${px}px, ${py}px) translate(-50%, -50%)`;
  }

  function resetJoystick() {
    jx = 0.0; jy = 0.0;
    setStickVisual(0.0, 0.0);
  }

  function updateFromPointer(clientX, clientY) {
    const rect = joy.getBoundingClientRect();
    const cx = rect.left + rect.width * 0.5;
    const cy = rect.top + rect.height * 0.5;

    // dx,dy in pixels relative to center
    let dx = clientX - cx;
    let dy = clientY - cy;

    const radius = rect.width * 0.5;
    const maxTravel = radius * 0.55;

    // clamp to circle
    const dist = Math.hypot(dx, dy);
    if (dist > maxTravel && dist > 0) {
      dx = dx * (maxTravel / dist);
      dy = dy * (maxTravel / dist);
    }

    // normalize to [-1..1]
    const nx = dx / maxTravel;
    const ny = -dy / maxTravel; // positive when moving up

    jx = clamp(nx, -1.0, 1.0);
    jy = clamp(ny, -1.0, 1.0);

    setStickVisual(jx, jy);
  }

  joy.addEventListener("pointerdown", (e) => {
    active = true;
    pointerId = e.pointerId;
    joy.setPointerCapture(pointerId);
    updateFromPointer(e.clientX, e.clientY);
  });

  joy.addEventListener("pointermove", (e) => {
    if (!active || e.pointerId !== pointerId) return;
    updateFromPointer(e.clientX, e.clientY);
  });

  function endPointer(e) {
    if (e.pointerId !== pointerId) return;
    active = false;
    pointerId = null;
    resetJoystick();
    // sofort Stop senden (zusätzlich Deadman im Server)
    send(0.0, 0.0);
    outEl.textContent = `v=0.00 m/s, w=0.00 rad/s`;
  }

  joy.addEventListener("pointerup", endPointer);
  joy.addEventListener("pointercancel", endPointer);
  joy.addEventListener("lostpointercapture", () => {
    if (active) {
      active = false;
      pointerId = null;
      resetJoystick();
    }
  });

  document.getElementById("stopBtn").addEventListener("click", () => {
    resetJoystick();
    send(0.0, 0.0);
    outEl.textContent = `v=0.00 m/s, w=0.00 rad/s`;
  });

  document.getElementById("recenterBtn").addEventListener("click", () => {
    resetJoystick();
  });

  // ---------- Control loop (20 Hz) ----------
  const PERIOD_MS = 50;

  setInterval(() => {
    // Wenn nicht aktiv: trotzdem regelmäßig Stop senden (optional).
    // Der Server hat Deadman; dieses Stop macht es "snappier".
    const dz = Number(deadzone.value);
    const e  = Number(expo.value);

    // Deadzone + Expo auf Joystick-Normwerte
    const x = applyExpo(applyDeadzone01(jx, dz), e);
    const y = applyExpo(applyDeadzone01(jy, dz), e);

    // Mapping: y -> v (vorwärts), x -> w (drehen)
    const vMax = Number(vmax.value);
    const wMax = Number(wmax.value);

    const v = clamp(y * vMax, -vMax, vMax);
    const w = clamp(x * wMax, -wMax, wMax);

    // Wenn nicht aktiv, optional "hart" stoppen:
    if (!active) {
      send(0.0, 0.0);
      outEl.textContent = `v=0.00 m/s, w=0.00 rad/s`;
      return;
    }

    send(v, w);
    outEl.textContent = `v=${v.toFixed(2)} m/s, w=${w.toFixed(2)} rad/s`;
  }, PERIOD_MS);

  // Initial visual
  resetJoystick();
</script>
</body>
</html>
